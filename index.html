<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Performant, scientific computation in Python and Rust</title>

    <link rel="stylesheet" href="./dist/reveal.css">
    <link rel="stylesheet" href="./dist/theme/sky.css" id="theme">

    <link rel="stylesheet" href="./plugin/highlight/monokai.css">
    <link href="https://fonts.cdnfonts.com/css/bloody" rel="stylesheet">
    <style>
        .container {
            display: flex;
        }

        .col {
            flex: 1;
        }
    </style>

</head>

<body>

    <div class="reveal">

        <div class="slides">

            <!--

                Title slides

             -->

            <section data-background-image="img/gmm.png">
                <h1 style="font-size: larger;">Performant, scientific computation in Python and
                    Rust </h1>
                <h2 style="font-size: x-large;">PyConDE & PyData Berlin 2024</h2>
            </section>

            <!-- Slides are separated by three dashes (the default) -->
            <section data-background-image="img/cult_lg.png">
                <h1 style="color:red; font-family: 'Bloody', sans-serif;" class="fragment fade-down"
                    data-fragment-index="1,2">
                    The Rust and the Python
                </h1>
                <h2 style="color:lightgray;" class="fragment fade-up" data-fragment-index="2">
                    Performant, scientific computation in Python and Rust
                </h2>
            </section>


            <!--

                Introduction

             -->


            <section> <!-- Drop down -->
                <section>
                    <h2>Who am I?</h2>
                    <div class="container" style="margin: 5%">

                        <div class="col">
                            <img src="img/qr-code.svg" alt="" width="50%">
                        </div>
                        <div class="col">
                            <ul>
                                <li> Data Scientist at BlueYonder </li>
                                <li> Research interests: Roboticist & Cognitive Cognition, Machine Learning
                                    (self-organization)
                                </li>
                                <li> Pythonista (> 15 years) and Rustacean (~2.5 years) </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section>
                    <h2> What to expect? </h2>

                    <ul>
                        <li>
                            A time-lapse of algorithm development from the formula <br /> to the optimized
                            package in Python and Rust

                        </li>
                        <li class="fragment fade-in" data-fragment-index="1"> Takeaways
                            <ul>
                                <li> Confidence in creating scientific / numeric / ML packages </li>
                                <li> Strength and weakness of Python and Rust </li>
                                <li> How well they actually play together </li>
                                <li> (Opinionated) Best practices and packaging </li>

                            </ul>
                        </li>
                        <li class="fragment fade-in" data-fragment-index="2">
                            All sources (including these slides) on <a
                                href="https://github.com/StefanUlbrich/PyCon2024">Github</a>
                        </li>
                        <li class="fragment fade-in" data-fragment-index="2">
                            Open source license (MIT). Feel free to use as a template!
                        </li>
                    </ul>

                </section>
                <section>
                    <h2> What to <b>not</b> expect? </h2>
                    <ul>
                        <li class="fragment fade-in" data-fragment-index="1"> A <a
                                href="https://google.github.io/comprehensive-rust/">comprehensive Rust</a> course
                        </li>
                        <li class="fragment fade-in" data-fragment-index="2"> Deep learning frameworks </li>
                        <li class="fragment fade-in" data-fragment-index="3"> Complex models such as LLM </li>
                        <li class="fragment fade-in" data-fragment-index="4"> No bugs </li>
                        <li class="fragment fade-in" data-fragment-index="4"> No typos </li>
                    </ul>
                </section>

                <section>
                    <h2> Structure </h2>
                    <ol>
                        <li> Gaussian Mixtures and Expectation Maximization </li>
                        <li> Python tooling, implementation and packaging </li>
                        <li> Rust: Brief overview, Python extension and benchmarking</li>
                    </ol>
                </section>
            </section>





            <!--


                GMM



             -->

            <section>
                <h2> Part 1 — Gaussian Mixtures and Expectation Maximization </h2>
            </section>

            <section>
                <div class="container" style="margin: 5%">

                    <div class="col">
                        <h2> Why <em>this</em> model? </h2>
                        <ul>
                            <li> Easy to understand </li>
                            <li> Educational yet useful / versatile </li>
                            <li> Easy / fast to implement (±50 LoC) </li>
                            <li> Easy / fast to train and evaluate </li>
                            <li> Bonus: Probabilistic </li>
                        </ul>
                    </div>
                    <div class="col">
                        <div class="fragment fade-in" data-fragment-index="2">
                            <h2> … and why not?</h2>
                            <ul>
                                <li> Easy to express with arrays (<tt>numpy</tt>, <tt>torch</tt>) </li>
                                <li> Difference to Rust not drastic </li>
                                <li> Better suited: Caching (e.g., dynamic programming), complex control flows, …
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h2> Formal definition </h2>

                <div class="container" style="margin: 5%">

                    <div class="col">
                        <div class="r-stack">
                            <img class="fragment fade-out" data-fragment-index="1" src="img/gmm.png" width="100%">
                            <img class="fragment fade-in" data-fragment-index="1" src="img/plate-notation.svg"
                                width="75%">
                            <!-- <img class="fragment fade-in" data-fragment-index="4" src="img/em4.png" width="75%"> -->
                        </div>
                    </div>
                    <div class="col">

                        <div class="r-stack">
                            <div class="fragment fade-out" data-fragment-index="1" style="scale: 80%;">
                                $$ \begin{aligned}
                                p(\bm x | M ) &= \sum_{m\in M} \pi_m \cdot p(\bm x | m) \\
                                &= \sum_{m\in M} \pi_m \cdot \mathcal N(x; \bm \mu_m, \Sigma_m) \\
                                \mathcal N(x; \bm \mu_m, \Sigma_m) &:= \frac{1}{ \sqrt{(2\pi)^d \det({\Sigma_m})} } \\ &
                                \qquad
                                \exp \left(-\frac{1}{2}({\mathbf x}-{\bm\mu_m})^{\top}{{\Sigma_m}}^{-1}({\bm
                                x}-{\bm\mu_m}) \right)
                                \end{aligned} $$

                                "A distribution over points where each point is drawn from one of multiple
                                Normal distributions (Gaussians)"
                            </div>
                            <div class="fragment fade-in" data-fragment-index="1">

                                $$ X = \left\{ \begin{pmatrix} \bm x_i \\ z_i \end{pmatrix}\right\}_i,
                                \quad \bm x_i \in \mathbb R^d, z_i \in M $$
                                <ul>
                                    <li class="fragment fade-in" data-fragment-index="1"> Data $\bm x_i$ is
                                        observable;
                                        $z_i$ non-observable / latent
                                    <li class="fragment fade-in" data-fragment-index="2"> 1 Multinomial/Categorical
                                        distribution </li>
                                    <li class="fragment fade-in" data-fragment-index="2"> $k$ Normal distributions
                                    </li>
                                    <li class="fragment fade-in" data-fragment-index="3">
                                        Each draw $i$ first determines the Normal distribution $z_i$
                                        and then the sample $\bm x_i$
                                    </li>
                                    <li class="fragment fade-in" data-fragment-index="4">
                                        Example: Weight / height distribution in an animal population
                                    </li>
                                    <li class="fragment fade-in" data-fragment-index="4"> <a
                                            href="https://lemonfold.io/posts/2022/aiml_essentials/part2/aiml-essentials-part2/">see
                                            my blog post (no formulas)</a> </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>



            <section>
                <h2> Expectation Maximization (EM) </h2>

                <p> Gaussian mixture models can be trained with EM </p>

                <div class="fragment fade-in" data-fragment-index="1">
                    $$ X = \left\{ \bm x_i\right\}_i, \quad \bm x \in \mathbb R^d $$
                </div>

                <ul>
                    <li class="fragment fade-in" data-fragment-index="1"> Algorithm for unsupervised learning /
                        Clustering </li>
                    <li class="fragment fade-in"> Missing data: We don't know which Gaussian $z_i$ produced $\bm
                        x_i$</li>
                    <li class="fragment fade-in"> The unobservable variable $z_1$ is called the <i>latent state</i>
                    </li>
                    <li class="fragment fade-in"> Alternating pattern: E-Step and M-Step </li>
                    <li class="fragment fade-in"> Guaranteed to converge but prone to local minima </li>
                    <div class="fragment fade-in">

                        <li> Many models can be trained with EM: </li>
                        <ul>
                            <li> $k$-Means </li>
                            <li> Self-organizing neural networks </li>
                            <li> Other mixture models </li>
                            <li> Hidden Markov Models </li>
                            <li> Kalmann filters </li>
                        </ul>
                    </div>
                </ul>
            </section>
            <section>
                <div>
                    <!-- <img class="fragment fade-out" data-fragment-index="1" src="img/em4.png" width="75%"> -->
                    <img src="img/anim2.gif" width="95%">
                </div>
                Training GMM with Expectation Maximization (for 2D clustering)
            </section>

            <section>
                <section>
                    <h2><b>E</b>(xpectation)-step (Intuition)</h2>

                    <div class="container" style="margin: 5%">
                        <div class="col">
                            <img src="img/expectation.png" width="75%">
                        </div>
                        <div class="col">
                            <ul>
                                <li> "Guessing the hidden states"</li>
                                <li> For each sample and each component,
                                    the probability that the sample has been generated by the component </li>
                                <li> Unlike $k$-means, points can belong to multiple clusters "soft assignment"</li>
                                <li> Number of data points $\times$ number of clusters probabilities
                                    ("responsibility
                                    matrix")</li>
                            </ul>
                        </div>
                    </div>
                </section>
                <section>
                    <h2><b>E</b>(xpectation)-step (Formula)</h2>

                    <div class="col">
                        $$
                        \begin{aligned}
                        \forall m \in M, \bm x \in X&: \\
                        \bar \gamma_{\bm x,m} &= \pi_m \cdot p(\bm x | m) \\
                        &= \pi_m \cdot \mathcal N( \bm x; \bm\mu_m, \Sigma_m) \\
                        \gamma_{\bm x,m} &= \frac{\bar \gamma_{\bm x, m}}{ \sum_{m \in M} \bar \gamma_{\bm x, m} }
                        \qquad
                        \text{(Bayes)} \\ \\
                        \mathcal N( \bm x; \bm\mu_m, \Sigma_m) &:= \frac{1}{ \sqrt{(2\pi)^d \det({\Sigma_m})} }
                        \exp \left(-\frac{1}{2}({\mathbf x}-{\bm\mu_m})^{\top}{{\Sigma_m}}^{\color{red}{-1}}({\bm
                        x}-{\bm\mu_m})
                        \right)\\
                        \end{aligned}
                        $$
                    </div>
                </section>
            </section>

            <section>
                <section>
                    <h2><b>M</b>(aximization)-step (Intuition)</h2>
                    <div class="container" style="margin: 5%">
                        <div class="col">
                            <img src="img/maximization.png" width="75%">
                        </div>
                        <div class="col">
                            <ul>
                                <li> Maximize the likelihood of the
                                    distribution with the guessed latent state (from the E-Step)</li>
                                <li> Compute the new parameters of each
                                    Gaussian </li>
                                <li> Sample mean and covariance weighted by the responsibilities (from the E-Step)
                                </li>
                                <li> We will implement this function in Rust </li>
                            </ul>
                        </div>
                </section>
                <section>
                    <h2><b>M</b>(aximization)-step (Formula)</h2>

                    <div style="margin: 100px">
                        $$ \begin{aligned}
                        \bm\mu_m &\leftarrow \frac{\sum_{\bm x \in X} \gamma_{\bm x,m} \cdot \bm x }{\sum_{\bm x \in
                        X}
                        \gamma_{\bm x,m}}
                        \\
                        \Sigma_m &\leftarrow \frac{\sum_{\bm x \in X} \gamma_{\bm x,m} \cdot (\bm x -
                        \bm\mu_m)^t\cdot
                        (\bm x - \bm \mu_m) }{\sum_{\bm x \in X} \gamma_{\bm x,m}}\\
                        \pi_m &\leftarrow \frac{\sum_{\bm x \in X}}{\sum_{\bm x \in X} \gamma_{\bm x,m}}
                        \end{aligned}
                        , \quad
                        $$
                    </div>
                </section>
            </section>


            <section>
                <h2> Applications </h2>
                <div class="r-stack">
                    <div class="fragment fade-out" data-fragment-index="1">
                        <img src="img/cluster3d.png">
                        <p> High-dimensional clustering (Warning: $\mathcal O(n^3)$!)</p>
                    </div>
                    <div class="fragment fade-in" data-fragment-index="1">
                        <img src="img/regression.png">
                        <p>

                        <ul>
                            <li> Regression </li>
                            <li> Image recognition </li>
                            <li> … </li>
                        </ul>
                        </p>
                    </div>
                </div>
            </section>
            </section>

            <!--


                Python


             -->
            <section>
                <h2> Part 2 — Python tooling, <br /> implementation and packaging </h2>
            </section>

            <section>
                <h2>
                    Setup
                </h2>
                <pre style="width: 60%;"><code data-trim data-noescape>
                        $ # Python packaging and dependency management
                        $ curl -LsSf https://astral.sh/uv/install.sh | sh
                        $ # Get the code
                        $ git clone https://github.com/StefanUlbrich/PyCon2024.git
                        $ cd PyCon2024 && git checkout skeleton
                        PyCon2024$ # Create virtual environment and install dependencies
                        PyCon2024$ uv env
                        PyCon2024$ uv pip sync requirements.txt
                        PyCon2024$ . ./venv/bin/activate
                    </code></pre>
                <ul>
                    <li>System setup (Python install, IDE setup, etc.) out of scope</li>
                    <li>All steps of the tutorial as git tags
                        (e.g., <a href="https://github.com/StefanUlbrich/PyCon2024/tree/skeleton">skeleton</a>
                        and
                        <a href="https://github.com/StefanUlbrich/PyCon2024/tree/rust_skeleton">rust-skeleton</a>)
                    </li>
                    <li>Tested on MacOS and Linux only (WSL should work)</li>
                    <li>I use <a href="https://code.visualstudio.com/">VSCode</a> and <a
                            href="https://jupyter.org/">Jupyter lab</a> for development and prototyping </li>
                </ul>
            </section>

            <section>
                <section>
                    <h2> GMM/EM in Python: </h2>
                    <h3> Design decisions </h3>


                    <div class="container" style="height: 100%; margin-top: 5%;">
                        <div class="col">
                            <ul>
                                <li> ADT / Data class represents the GMM </li>
                                <ul>
                                    <li>Numpy arrays for parameters</li>
                                    <li>Additional dimensions instead of lists</li>
                                </ul>
                                <li> No OOP</li>
                                <ul>
                                    <li> No OOP (easier to replace functions)</li>
                                    <li> EM implemented as three functions </li>
                                    <li> E-Step </li>
                                    <li> M-Step variants: 2 Python + 1 Rust </li>
                                    <li> Simple initialization: <br> (random $\gamma_{\bm x,m}$ + M-Step) </li>
                                </ul>
                                <li> Benchmark (timeit) and data generation </li>
                            </ul>
                        </div>
                        <div class="col">
                            <pre style="height: 80%; width: 80%;">
                                    <code data-trim data-line-numbers>
                                        @dataclass
                                        class GMM:
                                            means: NDArray[np.float64]              # k x d
                                            covs: NDArray[np.float64]               # k x d x d
                                            weights: NDArray[np.float64]            # k

                                        def expect(
                                            gmm: GaussianMixtureModel,
                                            data: NDArray[np.float64]               # n x d
                                        ) -> NDArray[np.float64]:                   # n x k
                                            ...

                                        def maximize(
                                            gmm: GaussianMixtureModel,
                                            responsibilities: NDArray[np.float64],  # n x k
                                            data: NDArray[np.float64]               # n x d
                                        ) -> None:
                                            ...
                                    </code>
                                </pre>
                        </div>

                    </div>
                </section>

                <section>
                    <h2> The E-Step </h2>



                    $$
                    \begin{aligned}
                    \forall m \in M, \bm x \in X&: \\
                    \bar \gamma_{\bm x,m} &= \pi_m \cdot p(\bm x | m) \\
                    &= \pi_m \cdot \mathcal N( \bm x; \bm\mu_m, \Sigma_m) \\
                    \gamma_{\bm x,m} &= \frac{\bar \gamma_{\bm x, m}}{ \sum_{m \in M} \bar \gamma_{\bm x, m} }\\
                    \mathcal N( \bm x; \bm\mu_m, \Sigma_m) &:= \pi_m \cdot \frac{1}{ \sqrt{(2\pi)^d \det({\Sigma_m})} }
                    \exp \left(-\frac{1}{2}({\mathbf x}-{\bm\mu_m})^{\top}{{\Sigma_m}}^{-1}({\bm x}-{\bm\mu_m})
                    \right)\\
                    \end{aligned}
                    $$
                    <p>
                        Intimidating, but …
                    <ul>
                        <li>Only $n\times k$ Gaussians </li>
                        <li>And normalization (Bayes theorem) </li>
                        <li> How hard can it be …? (live)</li>
                    </ul>

                    </p>

                </section>
                <section>
                    <h2> The M-Step — Naïve </h2>
                    <div style="margin: 100px">
                        $$ \begin{aligned}
                        \bm\mu_m &\leftarrow \frac{\sum_{\bm x \in X} \gamma_{\bm x,m} \cdot \bm x }{\sum_{\bm x \in X}
                        \gamma_{\bm x,m}} \\
                        \Sigma_m &\leftarrow \frac{\sum_{\bm x \in X} \gamma_{\bm x,m} \cdot (\bm x - \bm\mu_m)^t\cdot
                        (\bm x - \bm \mu_m) }{\sum_{\bm x \in X} \gamma_{\bm x,m}} \\
                        \pi_m &\leftarrow \frac{\sum_{\bm x \in X}}{\sum_{\bm x \in X} \gamma_{\bm x,m}}
                        \end{aligned}
                        $$
                    </div>

                    <ul>
                        <li> We will focus on the M-Step </li>
                        <li> Loops in python are slow. How can we avoid as many loops as possible </li>
                        <li> First naïve implementation (only one loop) </li>
                    </ul>
                </section>
                <section>
                    <h2> Look mom, no loops </h2>
                    <div class="r-stack">
                        <div class="fragment fade-out" data-fragment-index="1">
                            $$ \Sigma_m \leftarrow \frac{\sum_{\bm x \in X} \gamma_{\bm x,m} \cdot (\bm x -
                            \bm\mu_m)^t\cdot (\bm x - \bm \mu_m) }
                            {\sum_{\bm x \in X} \gamma_{\bm x,m}}, \qquad \forall m \in M
                            $$
                        </div>
                        <div class="fragment fade-in" data-fragment-index="1">
                            $$ \Sigma_m \leftarrow \frac{\sum_{\bm x \in X} \gamma_{\bm x,m} \cdot \bar{\bm x}_m^t\cdot
                            \bar{\bm x}_m }
                            {\sum_{\bm x \in X} \gamma_{\bm x,m}}, \qquad \bar{\bm x}_m = \bm x - \bm \mu_m, \quad
                            \forall m \in M
                            $$
                        </div>
                    </div>

                    <div class="r-stack" style="margin: 5%;">
                        <div class="fragment fade-in-then-out" data-fragment-index="2">
                            $$ \bar X_{k,n,d} \cdot \Gamma_{k,n} \cdot \bar X_{k,n,d} = \bm \Sigma_{k,d,d} $$
                        </div>
                        <div class="fragment fade-in-then-out" data-fragment-index="3">
                            <pre style="width: 100%;">
                                    <code data-trim>
                                        knd, kn, knd -> kdd
                                    </code>
                                </pre>
                        </div>
                        <div class="fragment fade-in-then-out" data-fragment-index="4">
                            <pre style="width: 100%;">
                                    <code data-trim>
                                        einstein_sum_notation('knd, kn, knd -> kdd', data, responsibilities, data)
                                    </code>
                                </pre>
                        </div>

                        <div class="fragment fade-in-then-out" data-fragment-index="5">
                            <pre style="width: 100%;">
                                    <code data-trim>
                                        einsum('knd, kn, knd -> kdd', data, responsibilities, data)
                                    </code>
                                </pre>
                        </div>
                        <div class="fragment fade-in" data-fragment-index="6">
                            <pre style="width: 100%;">
                                    <code data-trim>
                                        np.einsum('knd, kn, knd -> kdd', data, responsibilities, data)
                                    </code>
                                </pre>
                        </div>
                    </div>
                    <ul>
                        <li class="fragment fade-in" data-fragment-index="2"> Think in arrays to avoid loops! </li>
                        <li class="fragment fade-in" data-fragment-index="2"> This is called <a
                                href="https://en.wikipedia.org/wiki/Einstein_notation"> Einstein notation </a> </li>
                        <li class="fragment fade-in" data-fragment-index="6"> Included in Numpy! </li>
                        <li class="fragment fade-in" data-fragment-index="7"> Must be faster, right? Let's find out!
                        </li>
                    </ul>
                </section>
                <section>
                    <h2>
                        Benchmark
                    </h2>
                    <div style="margin: 5%;">
                        <pre style="width: 80%;"><code data-trim data-noescape>
                                data, _ = gmm.make_blobs(n_samples=10000, centers=20, n_features=2, random_state=7)

                                model = gmm.initialize(data, 20)
                                print(",",model.means)
                                r = gmm.expect(model, data)
                            </code></pre>
                        <div class="fragment fade-in">
                            <span> Pure Python with <code>einsum</code> </span>
                            <pre style="width: 80%;"><code data-trim data-noescape>
                                    13 ms ± 369 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
                                </code></pre>
                        </div>
                        <div class="fragment fade-in">
                            <span> Pure Python with loops </span>
                            <pre style="width: 80%;"><code data-trim data-noescape>
                                    7.37 ms ± 194 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
                                </code></pre>
                        </div>
                    </div>
                    <ul class="fragment fade-in">
                        <li> Python loops perform better! </li>
                        <li> Surprisingly, the loop version is faster </li>
                    </ul>
                </section>

            </section>



            <!--



                Rust



            -->

            <section>
                <h2> Part 3 — Rust: Brief overview, <br /> Python extension and benchmarking </h2>
                <img src="img/ferris.svg" width="200px" />
            </section>

            <section>
                <section>
                    <h2> Rust: A quick introduction </h2>
                    <blockquote cite="https://survey.stackoverflow.co/2022" style="margin-top: 5%; margin-bottom: 5%;">
                        Rust is on its seventh year as the most loved language with 87% of developers saying
                        they want to continue using it. Rust also ties with Python as the most wanted technology
                        with TypeScript running a close second. (<a
                            href="https://survey.stackoverflow.co/2022">stackoverflow survey 2022</a>)
                    </blockquote>
                    <ul>
                        <li> Developed by Graydon Hoare at Mozilla since 2010; first stable version 2015 </li>
                        <li> Feels modern, avoids pitfalls and is peformant ("zer cost") </li>
                        <li> but … it takes time to learn. C++ background definitively helpful </li>
                        <li> A very active, committed community </li>
                        <li> Common headline on hacker news: " * .. but written in Rust" </li>
                        <li> Overlap with Python: <tt>ruff</tt>, <tt>polars</tt>, <tt>uv</tt>, <tt>rye</tt>,
                            <tt>pixi</tt>, …
                        </li>
                        <li> Learning impacted my
                            <a href="https://kobzol.github.io/rust/python/2023/05/20/writing-python-like-its-rust.html"><i>
                                    style of Python </i></a>programming
                        </li>
                    </ul>
                </section>

                <section>
                    <h2> Structs and traits </h2>
                    <pre style="width: 60%; margin-top: 5%; margin-bottom: 5%;"><code data-trim data-noescape>
                            pub struct NewsArticle {
                                pub headline: String,
                                pub location: String,
                                pub author: String,
                                pub content: String,
                            }
                            pub trait Summary {
                                fn summarize(&self) -> String;
                            }
                            impl Summary for NewsArticle {
                                fn summarize(&self) -> String {
                                    format!("{}, by {} ({})", self.headline, self.author, self.location)
                                }
                            }

                        </code></pre>
                    <ul>
                        <li> No inheritance. No multiple inheritance. Use composition instead </li>
                        <li> Traits (interfaces) similar to <a
                                href="https://mypy.readthedocs.io/en/stable/protocols.html">Protocols</a> in Python
                        </li>
                    </ul>
                </section>
                <section>
                    <h2> Borrowing & Lifetimes </h2>

                    <pre style="width: 60%; margin-top: 5%; margin-bottom: 5%;"><code data-trim data-noescape>
                            let mut s = String::from("hello");

                            {
                                let r1 = &mut s;
                            } // r1 goes out of scope here, so we can make a new reference with no problems.

                            let r2 = &mut s;

                        </code></pre>

                    <ul>
                        <li> Rust is memory safe (like Python, unlike C/C++)</li>
                        <li> No garbage collection like Python / Java</li>
                        <li> No reference counting like C++ </li>
                        <li> The Borrowing checker enforces rules that prevent memory errors </li>
                    </ul>
                </section>
                <section>
                    <h2> Enums </h2>
                    <pre style="width: 60%; margin-top: 5%; margin-bottom: 5%;"><code data-trim data-noescape>
                            enum Message {
                                Quit,
                                Move { x: i32, y: i32 },
                                Write(String),
                                ChangeColor(i32, i32, i32),
                            }
                        </code></pre>
                    <ul>
                        <li> Algebraic data types </li>
                        <li> The foundation for elegant error handling and optional types </li>
                        <li> A <i>bit</i> like <tt>Union[T, …]</tt></li>
                    </ul>

                </section>
                <section>
                    <h2> … and much more </h2>
                    <ul>
                        <li> Powerful pattern matching </li>
                        <li> Functional programming </li>
                        <li> Excellent tooling </li>
                        <li> … </li>

                    </ul>
                </section>
            </section>



            <section>
                <section>
                    <h2>
                        Porting the M-Step to Rust
                    </h2>
                    <pre style="width: 60%;"><code data-trim data-noescape>
                            $ # Installation
                            $ curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
                            $ rustup update # Optional: Update the tool chain
                            $ cd PyCon2024 && git checkout rust-examples
                            PyCon2024$ # git checkout rust_test # or rust_skeleton
                        </code></pre>
                    <ul>
                        <li> <a href="https://www.rust-lang.org/tools/install"> Install instructions </a></li>
                        <li> Tested on MacOS and Linux only (WSL should work)</li>
                    </ul>
                </section>
                <section>
                    <h2> Loading numpy data </h2>
                    <pre style="width:80%; margin: 5%">
                            <code data-trim data-noescape>
                                fn main() {
                                    let data: Array2<f64> = read_npy("data/data.npy").unwrap();
                                    println!("{}", data);

                                    let responsibilities: Array2<f64> = read_npy("data/responsibilities.npy").unwrap();
                                    println!("{}", responsibilities);

                                    let means: Array2<f64> = read_npy("data/means.npy").unwrap();
                                    println!("{}", means);
                                }
                            </code>
                        </pre>

                </section>
                <section>
                    <h2>
                        Array passing
                    </h2>
                    <div class="r-stack">

                        <pre class="fragment fade-in" style="width:80%; margin: 5%">
                                <code data-trim data-noescape>
                                    use ndarray::prelude::*;

                                    pub fn foo(data: Array2<f64>) -> Array2<f64> { Array2::<f64>::zeros((0,0)) }
                                </code>
                            </pre>
                        <pre class="fragment fade-in" style="width:80%; margin: 5%">
                                <code data-trim data-noescape>
                                    use ndarray::prelude::*;

                                    pub fn foo(data: &Array2<f64>) -> Array2<f64> { Array2::<f64>::zeros((0,0)) }
                                </code>
                            </pre>
                        <pre class="fragment fade-in" style="width:80%; margin: 5%">
                                <code data-trim data-noescape>
                                    use ndarray::prelude::*;

                                    pub fn foo(mut data: &Array2<f64>, other: ArrayView2::<f64> )  {
                                        temp.assign(&data);
                                    }
                                </code>
                            </pre>
                        <pre class="fragment fade-in" style="width:80%; margin: 5%">
                                <code  data-trim data-noescape>
                                    <script type="text/template">
                                        use ndarray::prelude::*;

                                        pub fn foo<A, S>(points: &ArrayBase<S, Ix2>) -> Array1<A>
                                            where
                                                S: Data<Elem = A>,
                                                A: Float,
                                            {}
                                    </script>
                                </code>
                            </pre>
                    </div>
                    <ul>
                        <li> Ownership to arrays can be passed to a function </li>
                        <li> Arrays can be passed as a mutable or immutable reference </li>
                        <li> A view to an array can be generated that holds a reference </li>
                        <li> A function can be written in a generic way to accept all </li>
                        <li> Remember, in Python you don't even need the type </li>
                    </ul>
                </section>
                <section>
                    <h2>
                        Array handling
                    </h2>
                    <div class="fragment fade-in" class="container">
                        <span>Creating sums</span>
                        <div class="col">
                            <pre style="width:80%;">
                                    <code data-trim data-noescape>
                                        let sum_responsibilities = responsibilities.sum_axis(Axis(0));
                                    </code>
                                </pre>
                        </div>
                        <div class="col">
                            <pre style="width:80%">
                                    <code data-trim data-noescape>
                                        sum_responsibilities = responsibilities.sum(axis=1)
                                    </code>
                                </pre>
                        </div>
                    </div>
                    <div class="fragment fade-in" class="container">
                        <span>Broadcasting</span>
                        <div class="col">
                            <pre style="width:80%;">
                                    <code data-trim data-noescape>
                                        let x = (&responsibilities.slice(s![.., .., NewAxis]) * &data.slice(s![.., NewAxis, ..]))
                                    </code>
                                </pre>
                        </div>
                        <div class="col">
                            <pre style="width:80%;">
                                    <code data-trim data-noescape>
                                        x = np.sum(data[np.newaxis, :, :] * responsibilities[:, :, np.newaxis], axis=1)
                                    </code>
                                </pre>
                        </div>
                    </div>
                    <div class="fragment fade-in" class="container">
                        <span>Dot product</span>
                        <div class="col">
                            <pre style="width:80%;">
                                    <code data-trim data-noescape>
                                        let cov = &x.t().dot(&y)
                                    </code>
                                </pre>
                        </div>
                        <div class="col">
                            <pre style="width:80%;">
                                    <code data-trim data-noescape>
                                        covs = x.T @ y
                                    </code>
                                </pre>
                        </div>
                    </div>

                    <ul>
                        <li> <a href="https://github.com/rust-ndarray/ndarray"><code>ndarray</code></a> has an interface
                            that reminds of <code>numpy</code> </li>
                        <li> See the <a
                                href="https://docs.rs/ndarray/latest/ndarray/doc/ndarray_for_numpy_users/index.html">ndarray
                                for numpy users guide</a> </li>
                        <li> No <code>einsum</code> in Rust </li>
                    </ul>
                </section>
                <section>
                    <h2> The M-Step </h2>
                    <ul>
                        <li> The C-way </li>
                        <li> Iterators </li>
                        <li> Parallelization </li>
                        <li> Benchmarking with <a
                                href="https://github.com/bheisler/criterion.rs"><code>criterion.rs</code></a></li>
                    </ul>
                </section>
            </section>
            <section>
                <section>
                    <h2>
                        Creating the extension
                    </h2>
                    <pre style="width: 60%;"><code data-trim data-noescape>
                            PyCon2024$ git checkout bindings
                            PyCon2024$ # git checkout benchmarks # spoiler alert!
                            PyCon2024$ maturin develop -r --strip # Builds the extensions and adds it to the venv
                            PyCon2024$ maturin build -r --strip # Creates a binary wheel
                        </code></pre>
                    <ul>
                        <li> <a href="">PyO3</a> is a crate for the binding boilerplate </li>
                        <li> <a href="">Maturin</a> is a build tool. Shares <code>pyproject.toml</code>with poetry </li>
                    </ul>
                </section>

                <section>
                    <h2>
                        Benchmark
                    </h2>
                    <div style="margin: 5%;">
                        <pre style="width: 80%;"><code data-trim data-noescape>
                                data, _ = gmm.make_blobs(n_samples=10000, centers=20, n_features=2, random_state=7)

                                model = gmm.initialize(data, 20)
                                print(",",model.means)
                                r = gmm.expect(model, data)
                            </code></pre>
                        <div class="fragment fade-in">
                            <span> Pure Python with <code>einsum</code> </span>
                            <pre style="width: 80%;"><code data-trim data-noescape>
                                    13 ms ± 369 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
                                </code></pre>
                        </div>
                        <div class="fragment fade-in">
                            <span> Pure Python with loops </span>
                            <pre style="width: 80%;"><code data-trim data-noescape>
                                    7.37 ms ± 194 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
                                </code></pre>
                        </div>
                        <div class="fragment fade-in">
                            <span> Parallel Rust </span>
                            <pre style="width: 80%;"><code data-trim data-noescape>
                                    3.49 ms ± 23.2 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
                                </code></pre>
                        </div>
                    </div>
                    <ul class="fragment fade-in">
                        <li> MacBook, 2.6 GHz 6-Core Intel Core i7 </li>
                        <li> Rust wins due to parallelization</li>
                        <li> More analysis desired</li>
                    </ul>
                </section>

            </section>
            <section>
                <h2> Key takeaways </h2>
                <ul>
                    <li> Be confident in implementing scientific code! </li>
                    <li> It's fun creating mixed Rust/Python packages! </li>
                    <li> But it does not always make a lot of sense to do so </li>
                    <li class="fragment fade-in"> Never ask an AI to generate a picture with a crab together with a
                        python </li>
                </ul>
            </section>

            <section data-background-image=" img/hybrid.png">
                <h1 style="color:red;">
                    Thanks, enjoy the conference!
                </h1>
            </section>

        </div> <!-- slides -->
    </div> <!-- reveal-->

    <script src="./dist/reveal.js"></script>
    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>

    <script>

        Reveal.initialize({
            controls: true,
            progress: true,
            history: true,
            center: true,

            width: 1920,
            height: 1080,

            plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath.KaTeX]
        });

    </script>

</body>

</html>